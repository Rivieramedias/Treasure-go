<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Treasure-Go - Chasse au tr√©sor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Lien vers le manifeste pour la PWA -->
  <link rel="manifest" href="/Treasure-go/manifest.json" />
  <!-- Meta pour le th√®me de la PWA -->
  <meta name="theme-color" content="#000000" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    #map {
      height: 100vh;
      width: 100%;
      display: block; /* Assurer que la carte est visible d√®s le d√©part */
    }
    #info {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      font-size: 14px;
    }
    #toggleBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 48px;
      height: 48px;
      border-radius: 24px;
      background: #000;
      color: white;
      font-size: 20px;
      border: none;
      z-index: 2000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      cursor: pointer;
    }
    .speech-bubble {
      position: absolute;
      background: #fff;
      border: 2px solid #000;
      border-radius: 10px;
      padding: 10px;
      display: none;
      z-index: 1000;
      max-width: 200px;
      text-align: center;
      transform: translate(-50%, -100%);
    }
    .speech-bubble a {
      color: #1a73e8;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="info">Chargement...</div>
  <div id="map"></div>
  <button onclick="toggleInfo()" id="toggleBtn">üß≠</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Initialiser la carte imm√©diatement, car #map est visible
    console.log("D√©but de l'initialisation de la carte sur index.html");
    const map = L.map('map', { zoomControl: true }).setView([43.695, 7.255], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Forcer Leaflet √† recalculer les dimensions
    setTimeout(() => {
      map.invalidateSize();
      console.log("Carte initialis√©e sur index.html");
    }, 2000);

    let userMarker;
    const info = document.getElementById('info');
    const cdnIcons = {
      coffre: "https://cdn-icons-png.flaticon.com/64/4365/4365931.png",
      cle_doree: "https://cdn-icons-png.flaticon.com/64/3176/3176295.png",
      pierre_rouge: "https://audio-guides.eu/treasure/pirate.png",
      carte: "https://cdn-icons-png.flaticon.com/64/3541/3541885.png",
      epee: "https://cdn-icons-png.flaticon.com/64/3468/3468091.png",
      potion: "https://cdn-icons-png.flaticon.com/64/3063/3063829.png",
      diamant: "https://cdn-icons-png.flaticon.com/64/951/951195.png",
      piece_or: "https://cdn-icons-png.flaticon.com/64/4365/4365962.png",
      couronne: "https://cdn-icons-png.flaticon.com/64/3534/3534254.png",
      champagne: "https://cdn-icons-png.flaticon.com/64/2829/2829032.png",
      bateau_pirate: "https://cdn-icons-png.flaticon.com/64/4365/4365913.png"
    };

    // Charger les checkpoints depuis checkpoints.json
    fetch('/Treasure-go/checkpoints.json')
      .then(res => {
        if (!res.ok) {
          throw new Error(`Erreur HTTP : ${res.status}`);
        }
        return res.json();
      })
      .then(checkpoints => {
        console.log("Checkpoints charg√©s:", checkpoints);
        checkpoints.forEach(point => {
          const icon = L.icon({
            iconUrl: cdnIcons[point.item] || cdnIcons.coffre,
            iconSize: [48, 48],
            iconAnchor: [24, 48]
          });
          const marker = L.marker([point.lat, point.lon], { icon }).addTo(map);
          const circle = L.circle([point.lat, point.lon], { radius: point.radius, color: 'blue', fillOpacity: 0.1 }).addTo(map);

          // Ajouter une bulle personnalis√©e
          const bubble = L.divIcon({
            className: 'speech-bubble',
            html: `<div class="speech-bubble" id="bubble-${point.lat}-${point.lon}">${point.bubbleText || point.name}${point.link ? ` <a href="${point.link}" target="_blank">Cliquez ici</a>` : ''}</div>`,
            iconSize: [0, 0]
          });
          const bubbleMarker = L.marker([point.lat, point.lon], { icon: bubble }).addTo(map);

          marker.on('click', () => {
            if (point.sound) {
              const audio = new Audio(point.sound);
              audio.play().catch(err => console.log('Erreur lecture audio:', err));
            }
            const bubbleElement = document.getElementById(`bubble-${point.lat}-${point.lon}`);
            bubbleElement.style.display = 'block';
            setTimeout(() => {
              bubbleElement.style.display = 'none';
            }, 5000);
          });

          marker.point = point;
        });
        info.textContent = `Objets √† trouver : ${checkpoints.length}`;
      })
      .catch(err => {
        console.error('Erreur lors du chargement des checkpoints:', err);
        info.textContent = 'Erreur lors du chargement des objets. V√©rifiez votre connexion ou si le fichier checkpoints.json est disponible.';
      });

    // Suivre la position de l'utilisateur
    if ('geolocation' in navigator) {
      navigator.geolocation.watchPosition(position => {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;
        const latlng = L.latLng(userLat, userLon);

        if (!userMarker) {
          userMarker = L.marker(latlng, {
            icon: L.icon({
              iconUrl: 'https://cdn-icons-png.flaticon.com/64/25/25613.png',
              iconSize: [32, 32],
              iconAnchor: [16, 32]
            })
          }).addTo(map);
        } else {
          userMarker.setLatLng(latlng);
        }
        map.setView(latlng, 14);
        console.log("Position utilisateur mise √† jour:", userLat, userLon);
      }, err => {
        console.error('Erreur de g√©olocalisation:', err);
        let errorMessage = 'G√©olocalisation non disponible.';
        switch (err.code) {
          case 1: // PERMISSION_DENIED
            errorMessage = 'G√©olocalisation refus√©e. Veuillez autoriser l\'acc√®s dans les param√®tres de votre navigateur.';
            break;
          case 2: // POSITION_UNAVAILABLE
            errorMessage = 'Position indisponible. V√©rifiez que le GPS est activ√© et que vous avez une connexion r√©seau.';
            break;
          case 3: // TIMEOUT
            errorMessage = 'D√©lai d\'attente d√©pass√© pour la g√©olocalisation. R√©essayez plus tard.';
            break;
        }
        info.textContent = errorMessage;
      }, {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
      });
    } else {
      info.textContent = 'G√©olocalisation non support√©e par votre navigateur.';
    }

    function toggleInfo() {
      info.style.display = info.style.display === "none" ? "block" : "none";
    }

    // Enregistrement du Service Worker pour la PWA (d√©sactiv√© temporairement pour tester)
    /*
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/Treasure-go/sw.js')
          .then(registration => {
            console.log('Service Worker enregistr√© avec succ√®s:', registration);
          })
          .catch(err => {
            console.log('Erreur lors de l\'enregistrement du Service Worker:', err);
          });
      });
    }
    */
  </script>
</body>
</html>